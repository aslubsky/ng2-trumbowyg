export class TrumbowygSelectImagesPlugin {
    static init(editor, lang) {
        TrumbowygSelectImagesPlugin.editor = editor;
        TrumbowygSelectImagesPlugin.lang = lang;
        // console.log('TrumbowygSelectImagesPlugin init', editor);
        editor.plugins.selectImage = {
            init: function (trumbowyg) {
                trumbowyg.o.plugins.selectImage = trumbowyg.o.plugins.selectImage || {};
                // console.log('selectImage trumbowyg', trumbowyg);
                trumbowyg.addBtnDef('selectImage', {
                    fn: function (params) {
                        // console.log('selectImageCb', params, trumbowyg, editorImages);
                        TrumbowygSelectImagesPlugin.selectImageCb(params, trumbowyg, TrumbowygSelectImagesPlugin.editorImages);
                    }
                });
            },
            tag: 'img'
        };
    }
    static selectImageCb(params, t, editorImages) {
        var pfx = t.o.prefix;
        var i = 0, l = editorImages.length;
        if (l == 0) {
            return;
        }
        var html = [];
        var file = null;
        html.push('<div class="modal-container">');
        html.push('<ul class="' + pfx + 'select-images gallery">');
        for (; i < l; i++) {
            html.push('<li class="item" data-i="' + i + '"><label>' +
                '<img width="50px" src="' + editorImages[i].url + '"/>' + //editorImages[i].name +
                '</label></li>');
        }
        html.push('</ul>');
        html.push('</div>');
        var selectedImageIndex = null;
        var $modal = t.openModal(TrumbowygSelectImagesPlugin.editor.langs[TrumbowygSelectImagesPlugin.lang].attachedImages, html.join(''))
            .on('tbwconfirm', function () {
            t.restoreRange();
            t.syncCode();
            if (selectedImageIndex != null) {
                var width = editorImages[selectedImageIndex].width || 1024;
                t.execCmd('insertImage', editorImages[selectedImageIndex].url);
                if (width > 1024) {
                    jQuery('img[src="' + editorImages[selectedImageIndex].url + '"]:not([alt])', t.$box).attr('width', '1024px');
                }
            }
            setTimeout(function () {
                t.closeModal();
            }, 250);
        })
            .on('tbwcancel', function () {
            t.restoreRange();
            t.closeModal();
        });
        jQuery('li.item', $modal).on('click', function () {
            jQuery('li', $modal).removeClass('active');
            jQuery(this).addClass('active');
            selectedImageIndex = jQuery(this).data('i');
        });
    }
    ;
    static updateImages(files) {
        TrumbowygSelectImagesPlugin.editorImages = [];
        files.forEach((img) => {
            img.extension = img.extension || img.url.split('.').pop();
            if (TrumbowygSelectImagesPlugin.imagesExtensions.indexOf(img.extension) != -1) {
                // if (img.url.substring(0, 8) != '/uploads') {
                // img.url = '/uploads' + img.url;
                // }
                if (!img.width) {
                    var imgObj = new Image();
                    imgObj.setAttribute('data-i', TrumbowygSelectImagesPlugin.editorImages.length + '');
                    imgObj.onload = function (e) {
                        if (e.type !== 'error' && this.width) {
                            var indx = parseInt(this.getAttribute('data-i'));
                            TrumbowygSelectImagesPlugin.editorImages[indx].width = this.width;
                        }
                    };
                    imgObj.src = img.url;
                    img.width = 1024;
                }
                TrumbowygSelectImagesPlugin.editorImages.push(img);
            }
        });
    }
}
TrumbowygSelectImagesPlugin.editorImages = [];
TrumbowygSelectImagesPlugin.imagesExtensions = ['jpg', 'png', 'jpeg', 'bmp', 'gif', 'svg'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LWltYWdlcy5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS9hc2x1YnNreS93b3JrL2NvbGxhYm9yYXRvci9uZzItdHJ1bWJvd3lnL3NyYy8iLCJzb3VyY2VzIjpbInNlbGVjdC1pbWFnZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsTUFBTSxPQUFPLDJCQUEyQjtJQU83QixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQVcsRUFBRSxJQUFZO1FBQ3hDLDJCQUEyQixDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDNUMsMkJBQTJCLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUV4QywyREFBMkQ7UUFFM0QsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEdBQUc7WUFDekIsSUFBSSxFQUFFLFVBQVUsU0FBYztnQkFDMUIsU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7Z0JBQ3hFLG1EQUFtRDtnQkFDbkQsU0FBUyxDQUFDLFNBQVMsQ0FBQyxhQUFhLEVBQUU7b0JBQy9CLEVBQUUsRUFBRSxVQUFVLE1BQVc7d0JBQ3JCLGlFQUFpRTt3QkFDakUsMkJBQTJCLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsMkJBQTJCLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQzNHLENBQUM7aUJBQ0osQ0FBQyxDQUFDO1lBQ1AsQ0FBQztZQUNELEdBQUcsRUFBRSxLQUFLO1NBQ2IsQ0FBQTtJQUNMLENBQUM7SUFFTyxNQUFNLENBQUMsYUFBYSxDQUFDLE1BQVcsRUFBRSxDQUFNLEVBQUUsWUFBbUI7UUFDakUsSUFBSSxHQUFHLEdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDN0IsSUFBSSxDQUFDLEdBQVcsQ0FBQyxFQUNiLENBQUMsR0FBVyxZQUFZLENBQUMsTUFBTSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxJQUFJ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dHB1dCwgRXZlbnRFbWl0dGVyLCBFbGVtZW50UmVmLCBPbkluaXQsIE9uQ2hhbmdlc30gICAgICAgICBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuZGVjbGFyZSB2YXIgalF1ZXJ5OiBhbnk7XG5cbmV4cG9ydCBjbGFzcyBUcnVtYm93eWdTZWxlY3RJbWFnZXNQbHVnaW4ge1xuICAgIHB1YmxpYyBzdGF0aWMgZWRpdG9ySW1hZ2VzOiBhbnlbXSA9IFtdO1xuXG4gICAgcHVibGljIHN0YXRpYyBlZGl0b3I6IGFueTtcbiAgICBwdWJsaWMgc3RhdGljIGxhbmc6IHN0cmluZztcbiAgICBwdWJsaWMgc3RhdGljIGltYWdlc0V4dGVuc2lvbnM6IHN0cmluZ1tdID0gWydqcGcnLCAncG5nJywgJ2pwZWcnLCAnYm1wJywgJ2dpZicsICdzdmcnXTtcblxuICAgIHB1YmxpYyBzdGF0aWMgaW5pdChlZGl0b3I6IGFueSwgbGFuZzogc3RyaW5nKSB7XG4gICAgICAgIFRydW1ib3d5Z1NlbGVjdEltYWdlc1BsdWdpbi5lZGl0b3IgPSBlZGl0b3I7XG4gICAgICAgIFRydW1ib3d5Z1NlbGVjdEltYWdlc1BsdWdpbi5sYW5nID0gbGFuZztcblxuICAgICAgICAvLyBjb25zb2xlLmxvZygnVHJ1bWJvd3lnU2VsZWN0SW1hZ2VzUGx1Z2luIGluaXQnLCBlZGl0b3IpO1xuXG4gICAgICAgIGVkaXRvci5wbHVnaW5zLnNlbGVjdEltYWdlID0ge1xuICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24gKHRydW1ib3d5ZzogYW55KSB7XG4gICAgICAgICAgICAgICAgdHJ1bWJvd3lnLm8ucGx1Z2lucy5zZWxlY3RJbWFnZSA9IHRydW1ib3d5Zy5vLnBsdWdpbnMuc2VsZWN0SW1hZ2UgfHwge307XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3NlbGVjdEltYWdlIHRydW1ib3d5ZycsIHRydW1ib3d5Zyk7XG4gICAgICAgICAgICAgICAgdHJ1bWJvd3lnLmFkZEJ0bkRlZignc2VsZWN0SW1hZ2UnLCB7XG4gICAgICAgICAgICAgICAgICAgIGZuOiBmdW5jdGlvbiAocGFyYW1zOiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdzZWxlY3RJbWFnZUNiJywgcGFyYW1zLCB0cnVtYm93eWcsIGVkaXRvckltYWdlcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBUcnVtYm93eWdTZWxlY3RJbWFnZXNQbHVnaW4uc2VsZWN0SW1hZ2VDYihwYXJhbXMsIHRydW1ib3d5ZywgVHJ1bWJvd3lnU2VsZWN0SW1hZ2VzUGx1Z2luLmVkaXRvckltYWdlcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0YWc6ICdpbWcnXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBzZWxlY3RJbWFnZUNiKHBhcmFtczogYW55LCB0OiBhbnksIGVkaXRvckltYWdlczogYW55W10pIHtcbiAgICAgICAgdmFyIHBmeDogc3RyaW5nID0gdC5vLnByZWZpeDtcbiAgICAgICAgdmFyIGk6IG51bWJlciA9IDAsXG4gICAgICAgICAgICBsOiBudW1iZXIgPSBlZGl0b3JJbWFnZXMubGVuZ3RoO1xuICAgICAgICBpZiAobCA9PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgaHRtbDogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgdmFyIGZpbGU6IGFueSA9IG51bGw7XG4gICAgICAgIGh0bWwucHVzaCgnPGRpdiBjbGFzcz1cIm1vZGFsLWNvbnRhaW5lclwiPicpO1xuICAgICAgICBodG1sLnB1c2goJzx1bCBjbGFzcz1cIicgKyBwZnggKyAnc2VsZWN0LWltYWdlcyBnYWxsZXJ5XCI+Jyk7XG4gICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICBodG1sLnB1c2goJzxsaSBjbGFzcz1cIml0ZW1cIiBkYXRhLWk9XCInICsgaSArICdcIj48bGFiZWw+JyArXG4gICAgICAgICAgICAgICAgJzxpbWcgd2lkdGg9XCI1MHB4XCIgc3JjPVwiJyArIGVkaXRvckltYWdlc1tpXS51cmwgKyAnXCIvPicgKyAvL2VkaXRvckltYWdlc1tpXS5uYW1lICtcbiAgICAgICAgICAgICAgICAnPC9sYWJlbD48L2xpPidcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgaHRtbC5wdXNoKCc8L3VsPicpO1xuICAgICAgICBodG1sLnB1c2goJzwvZGl2PicpO1xuXG4gICAgICAgIHZhciBzZWxlY3RlZEltYWdlSW5kZXg6IG51bWJlciA9IG51bGw7XG4gICAgICAgIHZhciAkbW9kYWwgPSB0Lm9wZW5Nb2RhbChUcnVtYm93eWdTZWxlY3RJbWFnZXNQbHVnaW4uZWRpdG9yLmxhbmdzW1RydW1ib3d5Z1NlbGVjdEltYWdlc1BsdWdpbi5sYW5nXS5hdHRhY2hlZEltYWdlcywgaHRtbC5qb2luKCcnKSlcbiAgICAgICAgICAgIC5vbigndGJ3Y29uZmlybScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB0LnJlc3RvcmVSYW5nZSgpO1xuICAgICAgICAgICAgICAgIHQuc3luY0NvZGUoKTtcblxuICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZEltYWdlSW5kZXggIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgd2lkdGggPSBlZGl0b3JJbWFnZXNbc2VsZWN0ZWRJbWFnZUluZGV4XS53aWR0aCB8fCAxMDI0O1xuICAgICAgICAgICAgICAgICAgICB0LmV4ZWNDbWQoJ2luc2VydEltYWdlJywgZWRpdG9ySW1hZ2VzW3NlbGVjdGVkSW1hZ2VJbmRleF0udXJsKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdpZHRoID4gMTAyNCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KCdpbWdbc3JjPVwiJyArIGVkaXRvckltYWdlc1tzZWxlY3RlZEltYWdlSW5kZXhdLnVybCArICdcIl06bm90KFthbHRdKScsIHQuJGJveCkuYXR0cignd2lkdGgnLCAnMTAyNHB4Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdC5jbG9zZU1vZGFsKCk7XG4gICAgICAgICAgICAgICAgfSwgMjUwKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAub24oJ3Rid2NhbmNlbCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB0LnJlc3RvcmVSYW5nZSgpO1xuICAgICAgICAgICAgICAgIHQuY2xvc2VNb2RhbCgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgalF1ZXJ5KCdsaS5pdGVtJywgJG1vZGFsKS5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBqUXVlcnkoJ2xpJywgJG1vZGFsKS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7XG4gICAgICAgICAgICBqUXVlcnkodGhpcykuYWRkQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgc2VsZWN0ZWRJbWFnZUluZGV4ID0galF1ZXJ5KHRoaXMpLmRhdGEoJ2knKTtcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyBzdGF0aWMgdXBkYXRlSW1hZ2VzKGZpbGVzOiBhbnlbXSkge1xuICAgICAgICBUcnVtYm93eWdTZWxlY3RJbWFnZXNQbHVnaW4uZWRpdG9ySW1hZ2VzID0gW107XG4gICAgICAgIGZpbGVzLmZvckVhY2goKGltZzogYW55KSA9PiB7XG4gICAgICAgICAgICBpbWcuZXh0ZW5zaW9uID0gaW1nLmV4dGVuc2lvbiB8fCBpbWcudXJsLnNwbGl0KCcuJykucG9wKCk7XG4gICAgICAgICAgICBpZiAoVHJ1bWJvd3lnU2VsZWN0SW1hZ2VzUGx1Z2luLmltYWdlc0V4dGVuc2lvbnMuaW5kZXhPZihpbWcuZXh0ZW5zaW9uKSAhPSAtMSkge1xuICAgICAgICAgICAgICAgIC8vIGlmIChpbWcudXJsLnN1YnN0cmluZygwLCA4KSAhPSAnL3VwbG9hZHMnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGltZy51cmwgPSAnL3VwbG9hZHMnICsgaW1nLnVybDtcbiAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgaWYgKCFpbWcud2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGltZ09iaiA9IG5ldyBJbWFnZSgpO1xuICAgICAgICAgICAgICAgICAgICBpbWdPYmouc2V0QXR0cmlidXRlKCdkYXRhLWknLCBUcnVtYm93eWdTZWxlY3RJbWFnZXNQbHVnaW4uZWRpdG9ySW1hZ2VzLmxlbmd0aCArICcnKTtcbiAgICAgICAgICAgICAgICAgICAgaW1nT2JqLm9ubG9hZCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS50eXBlICE9PSAnZXJyb3InICYmICg8YW55PnRoaXMpLndpZHRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluZHggPSBwYXJzZUludCgoPGFueT50aGlzKS5nZXRBdHRyaWJ1dGUoJ2RhdGEtaScpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBUcnVtYm93eWdTZWxlY3RJbWFnZXNQbHVnaW4uZWRpdG9ySW1hZ2VzW2luZHhdLndpZHRoID0gKDxhbnk+dGhpcykud2lkdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaW1nT2JqLnNyYyA9IGltZy51cmw7XG4gICAgICAgICAgICAgICAgICAgIGltZy53aWR0aCA9IDEwMjQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFRydW1ib3d5Z1NlbGVjdEltYWdlc1BsdWdpbi5lZGl0b3JJbWFnZXMucHVzaChpbWcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=